<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mimir - 个人记忆与反思仪表盘</title>
    <link rel="icon" type="image/x-icon" href="icon/icon-32x32.ico">
    <link rel="shortcut icon" type="image/x-icon" href="icon/icon-32x32.ico">
    <!-- 引入 Google Fonts 的 Inter 字体 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- 链接到新的 CSS 文件 -->
    <link rel="stylesheet" href="dashboard.css">
</head>

<body>
    <div class="app-container">
        <!-- 头部 -->
        <header class="header">
            <div class="header-content">
                <h1 class="app-title">
                    <span class="logo">🧠</span>
                    Mimir - 个人记忆仪表盘
                </h1>
                <div class="header-actions">
                    <button class="settings-btn" id="dataManagerBtn" title="数据管理">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="9" y1="9" x2="9" y2="15"></line>
                            <line x1="15" y1="9" x2="15" y2="15"></line>
                        </svg>
                    </button>
                    <button class="settings-btn" id="settingsBtn" title="设置">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path
                                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                            </path>
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- 控制面板 -->
        <div class="control-panel">
            <div class="view-selector">
                <button class="view-btn active" id="dailyViewBtn">📅 每日视图</button>
                <button class="view-btn" id="annualViewBtn">📈 年度报告</button>
            </div>

            <div class="date-selector" id="dailyControls">
                <label for="dateInput">选择日期：</label>
                <div class="date-navigation">
                    <button class="btn btn-secondary btn-sm" id="prevDayBtn" title="前一天">◀</button>
                    <input type="date" id="dateInput" class="date-input">
                    <button class="btn btn-secondary btn-sm" id="nextDayBtn" title="后一天">▶</button>
                </div>
                <button class="btn btn-secondary" id="todayBtn">今天</button>
            </div>

            <div class="year-selector" id="annualControls" style="display: none;">
                <label for="yearInput">选择年份：</label>
                <select id="yearInput" class="year-input"></select>
                <button class="btn btn-secondary" id="currentYearBtn">今年</button>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" id="generateDiaryBtn">
                    ✨ 生成日记
                </button>
                <button class="btn btn-secondary" id="analyzeBtn">
                    � 仅分析数据告
                </button>
                <button class="btn btn-primary" id="generateAnnualBtn" style="display: none;">
                    � 生新成年度报告
                </button>
                <button class="btn btn-secondary" id="refreshBtn">
                    🔄 刷新数据
                </button>
            </div>
        </div>

        <!-- 数据概览 -->
        <div class="data-overview" id="dataOverview">
            <div class="overview-card">
                <h3>浏览页面</h3>
                <div class="count" id="pageCount">-</div>
            </div>
            <div class="overview-card">
                <h3>访问域名</h3>
                <div class="count" id="domainCount">-</div>
            </div>
            <div class="overview-card">
                <h3>活跃时段</h3>
                <div class="count" id="activeTime">-</div>
            </div>
        </div>

        <!-- 数据库统计 -->
        <div class="stats-container" id="statsContainer">
            <!-- 数据库统计信息将在这里动态插入 -->
        </div>

        <!-- 主内容区 (单列流式布局) -->
        <main class="main-content-flow">
            <!-- 浏览历史列表 (使用HTML5 details/summary实现可折叠功能) -->
            <details class="card history-section" id="historySection">
                <summary class="card-header collapsible-header">
                    <h3>今日浏览历史</h3>
                </summary>
                <div class="history-list-container">
                    <div class="history-list" id="historyList">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            <p>正在加载数据...</p>
                        </div>
                    </div>
                </div>
            </details>

            <!-- 数据分析结果 -->
            <div class="card analysis-section" id="analysisSection">
                <div class="analysis-header">
                    <h3>📈 智能数据分析</h3>
                    <div class="analysis-actions">
                        <button class="btn btn-secondary btn-sm" id="exportAnalysisBtn" style="display: none;">
                            📄 导出分析
                        </button>
                    </div>
                </div>

                <div class="loading-spinner" id="analysisLoadingSpinner" style="display: none;">
                    <div class="spinner"></div>
                    <p>🔍 正在分析您的浏览数据...</p>
                </div>

                <div class="ai-status" id="aiClassificationStatus" style="display: none;"></div>

                <div class="analysis-content" id="analysisContent">
                    <div class="placeholder">
                        <p>🔍</p>
                        <p>选择日期后点击"分析数据"按钮，AI将为您整理和分类浏览记录</p>
                    </div>
                </div>
            </div>

            <!-- 年度报告区 -->
            <div class="card annual-report-section" id="annualReportSection" style="display: none;">
                <div class="annual-header">
                    <h3>📈 年度浏览报告</h3>
                    <div class="annual-actions">
                        <button class="btn btn-secondary btn-sm" id="exportAnnualBtn" style="display: none;">
                            📄 导出报告
                        </button>
                    </div>
                </div>

                <div class="loading-spinner" id="annualLoadingSpinner" style="display: none;">
                    <div class="spinner"></div>
                    <p>⏳ 正在生成年度报告...</p>
                </div>

                <div class="annual-content" id="annualContent">
                    <div class="placeholder">
                        <p>📈</p>
                        <p>选择年份后点击"生成年度报告"按钮，系统将为您生成详细的年度浏览分析</p>
                        <div class="tips">
                            <h4>💡 使用提示</h4>
                            <ul>
                                <li>确保已授予浏览器历史记录权限</li>
                                <li>年度报告需要一定的浏览数据积累</li>
                                <li>如果某年份显示"无数据"，请选择其他年份</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI日记生成区 -->
            <div class="card diary-section" id="diarySection" style="display: none;">
                <div class="diary-header">
                    <h3>✨ AI生成的反思日记</h3>
                    <div class="diary-actions" id="diaryActions" style="display: none;">
                        <button class="btn btn-secondary btn-sm" id="copyBtn">
                            📋 复制
                        </button>
                        <button class="btn btn-success btn-sm" id="saveBtn">
                            💾 保存
                        </button>
                    </div>
                </div>
                <div class="diary-container">
                    <div class="loading-spinner" id="diaryLoadingSpinner" style="display: none;">
                        <div class="spinner"></div>
                        <p>正在生成您的个性化日记...</p>
                    </div>

                    <div class="diary-content" id="diaryContent">
                    </div>
                </div>
            </div>
        </main>



        <!-- 错误提示 -->
        <div class="error-message" id="errorMessage" style="display: none;">
            <div class="error-content">
                <span class="error-icon">⚠️</span>
                <span class="error-text" id="errorText"></span>
                <button class="close-error" id="closeErrorBtn">×</button>
            </div>
        </div>
    </div>

    <script src="lib/idb.js"></script>
    <script src="lib/error-handler.js"></script>
    <script src="lib/error-ui.js"></script>
    <script src="lib/mimir-db.js"></script>
    <script src="lib/db-wrapper.js"></script>
    <script src="lib/migration.js"></script>
    <script src="dashboard.js"></script>
</body>

</html>