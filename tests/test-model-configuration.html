<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡å‹é…ç½®æµ‹è¯• - Mimir</title>
    <link rel="icon" type="image/x-icon" href="../icon/icon-32x32.ico">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .warning { background-color: #fff3cd; color: #856404; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .log { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 4px; 
            font-family: monospace; 
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .config-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
        }
        .model-input {
            margin: 10px 0;
        }
        .model-input input {
            width: 300px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ æ¨¡å‹é…ç½®æµ‹è¯•</h1>
    
    <div class="test-section">
        <h3>é—®é¢˜æè¿°</h3>
        <p>ç”¨æˆ·åæ˜ ï¼šåœ¨è®¾ç½®ä¸­æ›´æ¢äº†åˆ†ææ¨¡å‹ï¼Œä½†ç³»ç»Ÿä»ç„¶è°ƒç”¨GPT-3.5æ¨¡å‹ã€‚</p>
        <p><strong>å¯èƒ½åŸå› </strong>ï¼š</p>
        <ul>
            <li>é…ç½®æ²¡æœ‰æ­£ç¡®ä¿å­˜</li>
            <li>é…ç½®æ²¡æœ‰æ­£ç¡®åŠ è½½</li>
            <li>ä»£ç ä¸­æœ‰ç¡¬ç¼–ç çš„é»˜è®¤å€¼</li>
            <li>å­—æ®µåä¸åŒ¹é…</li>
        </ul>
    </div>

    <div class="test-section">
        <h3>1. å½“å‰é…ç½®æ£€æŸ¥</h3>
        <button onclick="checkCurrentConfig()">æ£€æŸ¥å½“å‰é…ç½®</button>
        <div id="configResult"></div>
    </div>

    <div class="test-section">
        <h3>2. æ¨¡æ‹Ÿé…ç½®ä¿å­˜</h3>
        <div class="model-input">
            <label>åˆ†ææ¨¡å‹ï¼š</label>
            <input type="text" id="testAnalysisModel" placeholder="gpt-4o" value="gpt-4o">
        </div>
        <div class="model-input">
            <label>æ—¥è®°æ¨¡å‹ï¼š</label>
            <input type="text" id="testDiaryModel" placeholder="gpt-4" value="gpt-4">
        </div>
        <button onclick="saveTestConfig()">ä¿å­˜æµ‹è¯•é…ç½®</button>
        <button onclick="loadTestConfig()">åŠ è½½æµ‹è¯•é…ç½®</button>
        <div id="saveResult"></div>
    </div>

    <div class="test-section">
        <h3>3. æ¨¡å‹è°ƒç”¨æµ‹è¯•</h3>
        <button onclick="testModelUsage()">æµ‹è¯•æ¨¡å‹ä½¿ç”¨</button>
        <div id="modelUsageResult"></div>
    </div>

    <div class="test-section">
        <h3>4. ä¿®å¤å»ºè®®</h3>
        <div id="fixSuggestions"></div>
    </div>

    <div class="test-section">
        <h3>æµ‹è¯•æ—¥å¿—</h3>
        <div id="testLog" class="log"></div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„åº“ -->
    <script src="../lib/idb.js"></script>
    <script src="../lib/error-handler.js"></script>
    <script src="../lib/error-ui.js"></script>
    <script src="../lib/mimir-db.js"></script>
    <script src="../lib/db-wrapper.js"></script>

    <script>
        let testLog = '';
        
        function log(message) {
            testLog += new Date().toLocaleTimeString() + ': ' + message + '\n';
            document.getElementById('testLog').textContent = testLog;
            console.log(message);
        }

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="test-result ${type}">${message}</div>`;
        }

        // æ£€æŸ¥å½“å‰é…ç½®
        async function checkCurrentConfig() {
            log('å¼€å§‹æ£€æŸ¥å½“å‰é…ç½®...');
            
            try {
                // åˆå§‹åŒ–æ•°æ®åº“
                if (!window.dbWrapper) {
                    window.dbWrapper = new DatabaseWrapper();
                    await window.dbWrapper.initialize();
                }

                // è·å–å½“å‰é…ç½®
                const settings = await window.dbWrapper.get('mimir-config');
                const config = settings['mimir-config'] || {};

                const configDisplay = `
<div class="config-display">
<strong>å½“å‰é…ç½®ï¼š</strong>
{
  "apiKey": "${config.apiKey ? '***å·²è®¾ç½®***' : 'æœªè®¾ç½®'}",
  "apiUrl": "${config.apiUrl || 'æœªè®¾ç½®'}",
  "model": "${config.model || 'æœªè®¾ç½®'}",
  "diaryModel": "${config.diaryModel || 'æœªè®¾ç½®'}",
  "useAIClassification": ${config.useAIClassification},
  "customPrompt": "${config.customPrompt ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'}",
  "enableDiaryComparison": ${config.enableDiaryComparison},
  "enableStreaming": ${config.enableStreaming}
}
</div>`;

                let issues = [];
                if (!config.model || config.model === 'gpt-3.5-turbo') {
                    issues.push('âš ï¸ åˆ†ææ¨¡å‹ä»ä¸ºé»˜è®¤çš„gpt-3.5-turbo');
                }
                if (!config.diaryModel || config.diaryModel === 'gpt-4') {
                    issues.push('â„¹ï¸ æ—¥è®°æ¨¡å‹ä¸ºé»˜è®¤çš„gpt-4');
                }
                if (!config.apiKey) {
                    issues.push('âŒ API Keyæœªè®¾ç½®');
                }

                const resultHtml = configDisplay + (issues.length > 0 ? 
                    '<div class="test-result warning">' + issues.join('<br>') + '</div>' : 
                    '<div class="test-result success">âœ… é…ç½®çœ‹èµ·æ¥æ­£å¸¸</div>');

                document.getElementById('configResult').innerHTML = resultHtml;
                log('âœ… é…ç½®æ£€æŸ¥å®Œæˆ');
                
            } catch (error) {
                log('âŒ é…ç½®æ£€æŸ¥å¤±è´¥: ' + error.message);
                showResult('configResult', 'é…ç½®æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ä¿å­˜æµ‹è¯•é…ç½®
        async function saveTestConfig() {
            log('å¼€å§‹ä¿å­˜æµ‹è¯•é…ç½®...');
            
            try {
                if (!window.dbWrapper) {
                    window.dbWrapper = new DatabaseWrapper();
                    await window.dbWrapper.initialize();
                }

                const testConfig = {
                    apiKey: 'test-key',
                    apiUrl: 'https://api.openai.com/v1/chat/completions',
                    model: document.getElementById('testAnalysisModel').value,
                    diaryModel: document.getElementById('testDiaryModel').value,
                    useAIClassification: true,
                    customPrompt: '',
                    enableDiaryComparison: false,
                    enableStreaming: true
                };

                await window.dbWrapper.set({ 'mimir-config': testConfig });
                
                log('âœ… æµ‹è¯•é…ç½®ä¿å­˜æˆåŠŸ');
                showResult('saveResult', `âœ… é…ç½®å·²ä¿å­˜ï¼šåˆ†ææ¨¡å‹=${testConfig.model}, æ—¥è®°æ¨¡å‹=${testConfig.diaryModel}`, 'success');
                
            } catch (error) {
                log('âŒ ä¿å­˜æµ‹è¯•é…ç½®å¤±è´¥: ' + error.message);
                showResult('saveResult', 'ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½æµ‹è¯•é…ç½®
        async function loadTestConfig() {
            log('å¼€å§‹åŠ è½½æµ‹è¯•é…ç½®...');
            
            try {
                if (!window.dbWrapper) {
                    window.dbWrapper = new DatabaseWrapper();
                    await window.dbWrapper.initialize();
                }

                const settings = await window.dbWrapper.get('mimir-config');
                const config = settings['mimir-config'] || {};

                document.getElementById('testAnalysisModel').value = config.model || 'gpt-3.5-turbo';
                document.getElementById('testDiaryModel').value = config.diaryModel || 'gpt-4';
                
                log('âœ… æµ‹è¯•é…ç½®åŠ è½½æˆåŠŸ');
                showResult('saveResult', `âœ… é…ç½®å·²åŠ è½½ï¼šåˆ†ææ¨¡å‹=${config.model}, æ—¥è®°æ¨¡å‹=${config.diaryModel}`, 'success');
                
            } catch (error) {
                log('âŒ åŠ è½½æµ‹è¯•é…ç½®å¤±è´¥: ' + error.message);
                showResult('saveResult', 'åŠ è½½å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æµ‹è¯•æ¨¡å‹ä½¿ç”¨
        async function testModelUsage() {
            log('å¼€å§‹æµ‹è¯•æ¨¡å‹ä½¿ç”¨...');
            
            try {
                if (!window.dbWrapper) {
                    window.dbWrapper = new DatabaseWrapper();
                    await window.dbWrapper.initialize();
                }

                const settings = await window.dbWrapper.get('mimir-config');
                const config = settings['mimir-config'] || {};

                // æ¨¡æ‹Ÿdashboard.jsä¸­çš„æ¨¡å‹é€‰æ‹©é€»è¾‘
                const classificationConfig = {
                    ...config,
                    model: config.model || 'gpt-3.5-turbo',  // è¿™é‡Œæ˜¯é—®é¢˜æ‰€åœ¨ï¼
                    temperature: 0.1
                };

                const diaryConfig = {
                    ...config,
                    model: config.diaryModel || config.model || 'gpt-4',
                    temperature: 0.7
                };

                const results = [
                    `ğŸ” åˆ†ææ¨¡å‹å°†ä½¿ç”¨: <strong>${classificationConfig.model}</strong>`,
                    `âœ¨ æ—¥è®°æ¨¡å‹å°†ä½¿ç”¨: <strong>${diaryConfig.model}</strong>`,
                    `ğŸ“‹ ç”¨æˆ·è®¾ç½®çš„åˆ†ææ¨¡å‹: <strong>${config.model || 'æœªè®¾ç½®'}</strong>`,
                    `ğŸ“‹ ç”¨æˆ·è®¾ç½®çš„æ—¥è®°æ¨¡å‹: <strong>${config.diaryModel || 'æœªè®¾ç½®'}</strong>`
                ];

                let type = 'success';
                if (classificationConfig.model === 'gpt-3.5-turbo' && config.model && config.model !== 'gpt-3.5-turbo') {
                    results.push('<br>âŒ <strong>é—®é¢˜å‘ç°</strong>ï¼šç”¨æˆ·è®¾ç½®äº†ä¸åŒçš„æ¨¡å‹ï¼Œä½†ç³»ç»Ÿä»ä½¿ç”¨é»˜è®¤æ¨¡å‹ï¼');
                    type = 'error';
                }

                showResult('modelUsageResult', results.join('<br>'), type);
                log('âœ… æ¨¡å‹ä½¿ç”¨æµ‹è¯•å®Œæˆ');
                
            } catch (error) {
                log('âŒ æ¨¡å‹ä½¿ç”¨æµ‹è¯•å¤±è´¥: ' + error.message);
                showResult('modelUsageResult', 'æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºä¿®å¤å»ºè®®
        function showFixSuggestions() {
            const suggestions = `
<div class="test-result info">
<h4>ğŸ”§ ä¿®å¤å»ºè®®ï¼š</h4>
<ol>
<li><strong>æ£€æŸ¥å­—æ®µåä¸€è‡´æ€§</strong>ï¼šç¡®ä¿settings.jså’Œdashboard.jsä½¿ç”¨ç›¸åŒçš„å­—æ®µå</li>
<li><strong>ç§»é™¤ç¡¬ç¼–ç é»˜è®¤å€¼</strong>ï¼šåœ¨dashboard.jsä¸­ç§»é™¤ç¡¬ç¼–ç çš„'gpt-3.5-turbo'</li>
<li><strong>æ·»åŠ è°ƒè¯•æ—¥å¿—</strong>ï¼šåœ¨æ¨¡å‹é€‰æ‹©æ—¶æ·»åŠ console.logæ¥è¿½è¸ªå®é™…ä½¿ç”¨çš„æ¨¡å‹</li>
<li><strong>é…ç½®éªŒè¯</strong>ï¼šåœ¨ç”Ÿæˆæ—¥è®°å‰éªŒè¯é…ç½®æ˜¯å¦æ­£ç¡®åŠ è½½</li>
</ol>

<h4>ğŸš€ å·²ä¿®å¤çš„é—®é¢˜ï¼š</h4>
<ul>
<li>âœ… ä¿®å¤äº†dashboard.jsä¸­çš„å­—æ®µåä¸ä¸€è‡´é—®é¢˜ï¼ˆclassificationModel â†’ modelï¼‰</li>
<li>âœ… æ·»åŠ äº†emojiå­—ä½“æ”¯æŒï¼Œä¿®å¤å›¾æ ‡æ˜¾ç¤ºé—®é¢˜</li>
</ul>
</div>`;
            
            document.getElementById('fixSuggestions').innerHTML = suggestions;
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡Œ
        window.addEventListener('load', () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œæ¨¡å‹é…ç½®æµ‹è¯•å‡†å¤‡å°±ç»ª');
            showFixSuggestions();
            checkCurrentConfig();
        });
    </script>
</body>
</html>