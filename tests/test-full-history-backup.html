<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œæ•´å†å²è®°å½•å¤‡ä»½æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .test-button { background: #3498db; color: white; border: none; padding: 12px 24px; margin: 8px; border-radius: 4px; cursor: pointer; }
        .test-button:hover { background: #2980b9; }
        .test-button:disabled { background: #95a5a6; cursor: not-allowed; }
        .test-results { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status-indicator.success { background: #27ae60; }
        .status-indicator.error { background: #e74c3c; }
        .status-indicator.warning { background: #f39c12; }
        .status-indicator.info { background: #3498db; }
        .stats-card { background: #ecf0f1; padding: 15px; margin: 10px; border-radius: 8px; display: inline-block; min-width: 150px; text-align: center; }
        .stat-number { font-size: 24px; font-weight: bold; color: #2c3e50; }
        .stat-label { font-size: 12px; color: #7f8c8d; margin-top: 5px; }
    </style>
</head>
<body>
    <h1>å®Œæ•´å†å²è®°å½•å¤‡ä»½æµ‹è¯•</h1>
    <p>æµ‹è¯•ä¿®å¤åçš„å†å²è®°å½•å¤‡ä»½åŠŸèƒ½ï¼Œç¡®ä¿èƒ½å¤Ÿå¤„ç†æ‚¨çš„10793+æ¡è®°å½•</p>

    <div class="test-section">
        <h2>ğŸ“Š å½“å‰çŠ¶æ€</h2>
        <div class="stats-card">
            <div class="stat-number" id="browserCount">-</div>
            <div class="stat-label">æµè§ˆå™¨è®°å½•</div>
        </div>
        <div class="stats-card">
            <div class="stat-number" id="backupCount">-</div>
            <div class="stat-label">å·²å¤‡ä»½è®°å½•</div>
        </div>
        <div class="stats-card">
            <div class="stat-number" id="coveragePercent">-</div>
            <div class="stat-label">è¦†ç›–ç‡</div>
        </div>
        
        <button class="test-button" onclick="checkCurrentStatus()">ğŸ” æ£€æŸ¥å½“å‰çŠ¶æ€</button>
        <div id="statusResults" class="test-results"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ”„ å®Œæ•´å¤‡ä»½æµ‹è¯•</h2>
        <p><strong>è­¦å‘Šï¼š</strong>è¿™å°†å¤‡ä»½æ‚¨çš„æ‰€æœ‰å†å²è®°å½•ï¼Œå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´</p>
        
        <button class="test-button" onclick="testFullBackup()" id="fullBackupBtn">ğŸ”„ å¼€å§‹å®Œæ•´å¤‡ä»½æµ‹è¯•</button>
        <button class="test-button" onclick="testDatabaseQuery()" id="queryBtn">ğŸ” æµ‹è¯•æ•°æ®åº“æŸ¥è¯¢</button>
        
        <div id="backupResults" class="test-results"></div>
    </div>

    <script src="lib/idb.js"></script>
    <script src="lib/error-handler.js"></script>
    <script src="lib/mimir-db.js"></script>
    <script src="lib/db-wrapper.js"></script>

    <script>
        function log(section, message, type = 'info') {
            const resultsDiv = document.getElementById(section + 'Results');
            const timestamp = new Date().toLocaleTimeString();
            const statusClass = type === 'error' ? 'error' : type === 'warning' ? 'warning' : type === 'success' ? 'success' : 'info';
            resultsDiv.innerHTML += `<div><span class="status-indicator ${statusClass}"></span>[${timestamp}] ${message}</div>`;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        async function checkCurrentStatus() {
            try {
                log('status', 'æ£€æŸ¥å½“å‰å¤‡ä»½çŠ¶æ€...', 'info');
                
                const status = await new Promise((resolve) => {
                    chrome.runtime.sendMessage({ action: 'getBackupStatus' }, resolve);
                });
                
                if (status.success) {
                    document.getElementById('browserCount').textContent = status.browserHistoryCount.toLocaleString();
                    document.getElementById('backupCount').textContent = status.totalBackedUpRecords.toLocaleString();
                    document.getElementById('coveragePercent').textContent = status.backupCoverage + '%';
                    
                    log('status', `âœ“ æµè§ˆå™¨å†å²è®°å½•: ${status.browserHistoryCount.toLocaleString()} æ¡`, 'success');
                    log('status', `âœ“ å·²å¤‡ä»½è®°å½•: ${status.totalBackedUpRecords.toLocaleString()} æ¡`, 'success');
                    log('status', `âœ“ å¤‡ä»½è¦†ç›–ç‡: ${status.backupCoverage}%`, status.backupCoverage >= 90 ? 'success' : 'warning');
                    
                    if (status.needsFullBackup) {
                        log('status', 'âš  å»ºè®®è¿›è¡Œå®Œæ•´å¤‡ä»½ä»¥æé«˜è¦†ç›–ç‡', 'warning');
                    }
                } else {
                    log('status', `âœ— è·å–çŠ¶æ€å¤±è´¥: ${status.error}`, 'error');
                }
            } catch (error) {
                log('status', `âœ— æ£€æŸ¥çŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testFullBackup() {
            const confirmed = confirm('ç¡®å®šè¦è¿›è¡Œå®Œæ•´å¤‡ä»½æµ‹è¯•å—ï¼Ÿ\n\nè¿™å°†å¤‡ä»½æ‚¨çš„æ‰€æœ‰å†å²è®°å½•ï¼Œå¯èƒ½éœ€è¦10-20åˆ†é’Ÿæ—¶é—´ã€‚');
            if (!confirmed) return;
            
            try {
                const btn = document.getElementById('fullBackupBtn');
                btn.disabled = true;
                btn.textContent = 'ğŸ”„ å®Œæ•´å¤‡ä»½è¿›è¡Œä¸­...';
                
                log('backup', 'å¼€å§‹å®Œæ•´å¤‡ä»½æµ‹è¯•...', 'warning');
                log('backup', 'è¯·è€å¿ƒç­‰å¾…ï¼Œè¿™å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´...', 'info');
                
                const startTime = Date.now();
                const result = await new Promise((resolve) => {
                    chrome.runtime.sendMessage({ action: 'fullBackupHistory' }, resolve);
                });
                
                const duration = Date.now() - startTime;
                
                if (result.success) {
                    log('backup', `âœ“ å®Œæ•´å¤‡ä»½æˆåŠŸï¼`, 'success');
                    log('backup', `âœ“ è€—æ—¶: ${(duration/1000/60).toFixed(2)} åˆ†é’Ÿ`, 'success');
                    log('backup', `âœ“ å¤„ç†è®°å½•: ${result.totalRecords.toLocaleString()} æ¡`, 'info');
                    log('backup', `âœ“ æ–°å¢å¤‡ä»½: ${result.backedUpRecords.toLocaleString()} æ¡`, 'success');
                    log('backup', `âœ“ è·³è¿‡é‡å¤: ${result.skippedRecords.toLocaleString()} æ¡`, 'info');
                    
                    // åˆ·æ–°çŠ¶æ€
                    await checkCurrentStatus();
                } else {
                    log('backup', `âœ— å®Œæ•´å¤‡ä»½å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                log('backup', `âœ— å¤‡ä»½æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            } finally {
                const btn = document.getElementById('fullBackupBtn');
                btn.disabled = false;
                btn.textContent = 'ğŸ”„ å¼€å§‹å®Œæ•´å¤‡ä»½æµ‹è¯•';
            }
        }

        async function testDatabaseQuery() {
            try {
                log('backup', 'æµ‹è¯•æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½...', 'info');
                
                const db = new MimirDB();
                await db.initialize();
                
                const startTime = Date.now();
                const allHistory = await db.getAllHistory(); // ç°åœ¨åº”è¯¥è¿”å›æ‰€æœ‰è®°å½•
                const queryTime = Date.now() - startTime;
                
                log('backup', `âœ“ æŸ¥è¯¢å®Œæˆï¼Œè€—æ—¶: ${queryTime}ms`, 'success');
                log('backup', `âœ“ æ•°æ®åº“ä¸­çš„è®°å½•æ•°: ${allHistory.length.toLocaleString()} æ¡`, 'success');
                
                if (allHistory.length > 1000) {
                    log('backup', `âœ“ æˆåŠŸçªç ´1000æ¡é™åˆ¶ï¼`, 'success');
                } else {
                    log('backup', `âš  è®°å½•æ•°ä»ç„¶è¾ƒå°‘ï¼Œå¯èƒ½éœ€è¦è¿›è¡Œå®Œæ•´å¤‡ä»½`, 'warning');
                }
                
            } catch (error) {
                log('backup', `âœ— æ•°æ®åº“æŸ¥è¯¢å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥çŠ¶æ€
        window.addEventListener('load', () => {
            log('status', 'é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹æ£€æŸ¥çŠ¶æ€...', 'info');
            checkCurrentStatus();
        });
    </script>
</body>
</html>