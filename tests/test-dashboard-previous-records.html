<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•ä»ªè¡¨ç›˜å†å²è®°å½•æ˜¾ç¤º</title>
    <link rel="icon" type="image/x-icon" href="../icon/icon-32x32.ico">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .log { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 4px; 
            font-family: monospace; 
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª ä»ªè¡¨ç›˜å†å²è®°å½•æ˜¾ç¤ºæµ‹è¯•</h1>
    
    <div class="test-section">
        <h3>æµ‹è¯•ç›®æ ‡</h3>
        <ul>
            <li>âœ… éªŒè¯"ä»Šæ—¥æµè§ˆå†å²"é»˜è®¤å…³é—­</li>
            <li>âœ… éªŒè¯æ²¡æœ‰é‡å¤çš„â–¼ç¬¦å·</li>
            <li>ğŸ” éªŒè¯èƒ½æ­£ç¡®æ˜¾ç¤ºå’Œè¯»å–ä¹‹å‰çš„è®°å½•ï¼ˆæ—¥è®°ã€åˆ†ç±»ç¼“å­˜ã€å¹´åº¦æŠ¥å‘Šï¼‰</li>
        </ul>
    </div>

    <div class="test-section">
        <h3>1. HTMLç»“æ„æµ‹è¯•</h3>
        <button onclick="testHTMLStructure()">æµ‹è¯•HTMLç»“æ„</button>
        <div id="htmlTestResult"></div>
    </div>

    <div class="test-section">
        <h3>2. æ•°æ®åº“è®°å½•æµ‹è¯•</h3>
        <button onclick="createTestData()">åˆ›å»ºæµ‹è¯•æ•°æ®</button>
        <button onclick="testDatabaseRecords()">æµ‹è¯•æ•°æ®åº“è®°å½•</button>
        <div id="dbTestResult"></div>
    </div>

    <div class="test-section">
        <h3>3. å†å²è®°å½•æ˜¾ç¤ºæµ‹è¯•</h3>
        <button onclick="testHistoryDisplay()">æµ‹è¯•å†å²è®°å½•æ˜¾ç¤º</button>
        <div id="historyTestResult"></div>
    </div>

    <div class="test-section">
        <h3>æµ‹è¯•æ—¥å¿—</h3>
        <div id="testLog" class="log"></div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„åº“ -->
    <script src="../lib/idb.js"></script>
    <script src="../lib/error-handler.js"></script>
    <script src="../lib/error-ui.js"></script>
    <script src="../lib/mimir-db.js"></script>
    <script src="../lib/db-wrapper.js"></script>
    <script src="../lib/migration.js"></script>

    <script>
        let testLog = '';
        
        function log(message) {
            testLog += new Date().toLocaleTimeString() + ': ' + message + '\n';
            document.getElementById('testLog').textContent = testLog;
            console.log(message);
        }

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="test-result ${type}">${message}</div>`;
        }

        // æµ‹è¯•HTMLç»“æ„
        async function testHTMLStructure() {
            log('å¼€å§‹æµ‹è¯•HTMLç»“æ„...');
            
            try {
                // æ¨¡æ‹ŸåŠ è½½dashboard.htmlå†…å®¹è¿›è¡Œæµ‹è¯•
                const response = await fetch('../dashboard.html');
                const htmlContent = await response.text();
                
                // æ£€æŸ¥ä»Šæ—¥æµè§ˆå†å²æ˜¯å¦é»˜è®¤å…³é—­ï¼ˆæ²¡æœ‰openå±æ€§ï¼‰
                const hasOpenAttribute = htmlContent.includes('<details class="card history-section" id="historySection" open>');
                const hasClosedDetails = htmlContent.includes('<details class="card history-section" id="historySection">');
                
                // æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤çš„â–¼ç¬¦å·
                const arrowCount = (htmlContent.match(/â–¼/g) || []).length;
                
                let results = [];
                
                if (!hasOpenAttribute && hasClosedDetails) {
                    results.push('âœ… ä»Šæ—¥æµè§ˆå†å²é»˜è®¤å…³é—­çŠ¶æ€æ­£ç¡®');
                    log('âœ… ä»Šæ—¥æµè§ˆå†å²é»˜è®¤å…³é—­');
                } else {
                    results.push('âŒ ä»Šæ—¥æµè§ˆå†å²çŠ¶æ€ä¸æ­£ç¡®');
                    log('âŒ ä»Šæ—¥æµè§ˆå†å²çŠ¶æ€é”™è¯¯');
                }
                
                if (arrowCount === 0) {
                    results.push('âœ… æ²¡æœ‰é‡å¤çš„â–¼ç¬¦å·');
                    log('âœ… æ²¡æœ‰å‘ç°â–¼ç¬¦å·');
                } else {
                    results.push(`âŒ å‘ç°${arrowCount}ä¸ªâ–¼ç¬¦å·`);
                    log(`âŒ å‘ç°${arrowCount}ä¸ªâ–¼ç¬¦å·`);
                }
                
                showResult('htmlTestResult', results.join('<br>'), 'success');
                
            } catch (error) {
                log('âŒ HTMLç»“æ„æµ‹è¯•å¤±è´¥: ' + error.message);
                showResult('htmlTestResult', 'æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ›å»ºæµ‹è¯•æ•°æ®
        async function createTestData() {
            log('å¼€å§‹åˆ›å»ºæµ‹è¯•æ•°æ®...');
            
            try {
                // åˆå§‹åŒ–æ•°æ®åº“
                if (!window.dbWrapper) {
                    window.dbWrapper = new DatabaseWrapper();
                    await window.dbWrapper.initialize();
                }
                
                const today = new Date().toISOString().split('T')[0];
                const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                const currentYear = new Date().getFullYear();
                
                // åˆ›å»ºæµ‹è¯•åˆ†ç±»æ•°æ®
                const testClassifiedData = {
                    date: yesterday,
                    totalItems: 10,
                    categories: [
                        {
                            name: 'ç¼–ç¨‹ä¸å¼€å‘',
                            count: 5,
                            domains: ['github.com', 'stackoverflow.com'],
                            keyTitles: ['Reactæ–‡æ¡£', 'JavaScriptæ•™ç¨‹']
                        }
                    ]
                };
                
                // åˆ›å»ºæµ‹è¯•æ—¥è®°æ•°æ®
                const testDiary = `# ${yesterday} çš„åæ€æ—¥è®°\n\nä»Šå¤©ä¸»è¦ä¸“æ³¨äºç¼–ç¨‹å­¦ä¹ ï¼Œæµè§ˆäº†Reactç›¸å…³æ–‡æ¡£...`;
                
                // åˆ›å»ºæµ‹è¯•å¹´åº¦æŠ¥å‘Šæ•°æ®
                const testAnnualReport = {
                    year: currentYear,
                    generatedAt: new Date().toISOString(),
                    summary: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å¹´åº¦æŠ¥å‘Š',
                    totalVisits: 1000,
                    topCategories: ['ç¼–ç¨‹ä¸å¼€å‘', 'å·¥ä½œä¸ç”Ÿäº§åŠ›']
                };
                
                // ä¿å­˜æµ‹è¯•æ•°æ®
                await window.dbWrapper.set({
                    [`classified-${yesterday}`]: testClassifiedData,
                    [`diary-${yesterday}`]: testDiary,
                    [`annual-report-${currentYear}`]: testAnnualReport
                });
                
                log('âœ… æµ‹è¯•æ•°æ®åˆ›å»ºæˆåŠŸ');
                showResult('dbTestResult', 'âœ… æµ‹è¯•æ•°æ®åˆ›å»ºæˆåŠŸ', 'success');
                
            } catch (error) {
                log('âŒ åˆ›å»ºæµ‹è¯•æ•°æ®å¤±è´¥: ' + error.message);
                showResult('dbTestResult', 'åˆ›å»ºæµ‹è¯•æ•°æ®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æµ‹è¯•æ•°æ®åº“è®°å½•
        async function testDatabaseRecords() {
            log('å¼€å§‹æµ‹è¯•æ•°æ®åº“è®°å½•...');
            
            try {
                if (!window.dbWrapper) {
                    window.dbWrapper = new DatabaseWrapper();
                    await window.dbWrapper.initialize();
                }
                
                const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                const currentYear = new Date().getFullYear();
                
                // æ£€æŸ¥åˆ†ç±»æ•°æ®
                const classifiedResult = await window.dbWrapper.get(`classified-${yesterday}`);
                const hasClassified = classifiedResult[`classified-${yesterday}`];
                
                // æ£€æŸ¥æ—¥è®°æ•°æ®
                const diaryResult = await window.dbWrapper.get(`diary-${yesterday}`);
                const hasDiary = diaryResult[`diary-${yesterday}`];
                
                // æ£€æŸ¥å¹´åº¦æŠ¥å‘Šæ•°æ®
                const reportResult = await window.dbWrapper.get(`annual-report-${currentYear}`);
                const hasReport = reportResult[`annual-report-${currentYear}`];
                
                let results = [];
                
                if (hasClassified) {
                    results.push(`âœ… æ‰¾åˆ°${yesterday}çš„åˆ†ç±»ç¼“å­˜æ•°æ®`);
                    log(`âœ… åˆ†ç±»æ•°æ®: ${JSON.stringify(hasClassified).substring(0, 100)}...`);
                } else {
                    results.push(`âŒ æœªæ‰¾åˆ°${yesterday}çš„åˆ†ç±»ç¼“å­˜æ•°æ®`);
                }
                
                if (hasDiary) {
                    results.push(`âœ… æ‰¾åˆ°${yesterday}çš„æ—¥è®°æ•°æ®`);
                    log(`âœ… æ—¥è®°æ•°æ®: ${hasDiary.substring(0, 50)}...`);
                } else {
                    results.push(`âŒ æœªæ‰¾åˆ°${yesterday}çš„æ—¥è®°æ•°æ®`);
                }
                
                if (hasReport) {
                    results.push(`âœ… æ‰¾åˆ°${currentYear}å¹´çš„å¹´åº¦æŠ¥å‘Š`);
                    log(`âœ… å¹´åº¦æŠ¥å‘Š: ${JSON.stringify(hasReport).substring(0, 100)}...`);
                } else {
                    results.push(`âŒ æœªæ‰¾åˆ°${currentYear}å¹´çš„å¹´åº¦æŠ¥å‘Š`);
                }
                
                showResult('dbTestResult', results.join('<br>'), results.every(r => r.startsWith('âœ…')) ? 'success' : 'error');
                
            } catch (error) {
                log('âŒ æ•°æ®åº“è®°å½•æµ‹è¯•å¤±è´¥: ' + error.message);
                showResult('dbTestResult', 'æ•°æ®åº“è®°å½•æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æµ‹è¯•å†å²è®°å½•æ˜¾ç¤º
        async function testHistoryDisplay() {
            log('å¼€å§‹æµ‹è¯•å†å²è®°å½•æ˜¾ç¤ºåŠŸèƒ½...');
            
            try {
                // æ¨¡æ‹Ÿdashboard.jsçš„å…³é”®å‡½æ•°
                const mockDashboard = {
                    currentDate: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    
                    async loadAnalysisData() {
                        const classifiedKey = `classified-${this.currentDate}`;
                        const classifiedResult = await window.dbWrapper.get(classifiedKey);
                        
                        if (classifiedResult[classifiedKey]) {
                            log(`âœ… æˆåŠŸåŠ è½½${this.currentDate}çš„åˆ†ææ•°æ®`);
                            return { success: true, data: classifiedResult[classifiedKey] };
                        } else {
                            log(`â„¹ï¸ ${this.currentDate}æ²¡æœ‰åˆ†ææ•°æ®ï¼Œæ˜¾ç¤ºå ä½ç¬¦`);
                            return { success: false, placeholder: true };
                        }
                    },
                    
                    async loadDiaryData() {
                        const diaryKey = `diary-${this.currentDate}`;
                        const diaryResult = await window.dbWrapper.get(diaryKey);
                        
                        if (diaryResult[diaryKey]) {
                            log(`âœ… æˆåŠŸåŠ è½½${this.currentDate}çš„æ—¥è®°æ•°æ®`);
                            return { success: true, data: diaryResult[diaryKey] };
                        } else {
                            log(`â„¹ï¸ ${this.currentDate}æ²¡æœ‰æ—¥è®°æ•°æ®ï¼Œéšè—æ—¥è®°åŒºåŸŸ`);
                            return { success: false, hidden: true };
                        }
                    },
                    
                    async onYearChange() {
                        const year = new Date().getFullYear();
                        const reportKey = `annual-report-${year}`;
                        const existingReport = await window.dbWrapper.get(reportKey);
                        
                        if (existingReport[reportKey]) {
                            log(`âœ… æ‰¾åˆ°${year}å¹´çš„å·²æœ‰æŠ¥å‘Šï¼Œç›´æ¥æ˜¾ç¤º`);
                            return { success: true, existing: true, data: existingReport[reportKey] };
                        } else {
                            log(`â„¹ï¸ ${year}å¹´æ²¡æœ‰å·²æœ‰æŠ¥å‘Šï¼Œæ˜¾ç¤ºç”ŸæˆæŒ‰é’®`);
                            return { success: false, needGenerate: true };
                        }
                    }
                };
                
                // æµ‹è¯•å„ä¸ªåŠŸèƒ½
                const analysisResult = await mockDashboard.loadAnalysisData();
                const diaryResult = await mockDashboard.loadDiaryData();
                const annualResult = await mockDashboard.onYearChange();
                
                let results = [];
                
                if (analysisResult.success) {
                    results.push('âœ… åˆ†ææ•°æ®åŠ è½½åŠŸèƒ½æ­£å¸¸');
                } else if (analysisResult.placeholder) {
                    results.push('âœ… åˆ†ææ•°æ®å ä½ç¬¦æ˜¾ç¤ºæ­£å¸¸');
                } else {
                    results.push('âŒ åˆ†ææ•°æ®åŠ è½½å¼‚å¸¸');
                }
                
                if (diaryResult.success) {
                    results.push('âœ… æ—¥è®°æ•°æ®åŠ è½½åŠŸèƒ½æ­£å¸¸');
                } else if (diaryResult.hidden) {
                    results.push('âœ… æ—¥è®°æ•°æ®éšè—é€»è¾‘æ­£å¸¸');
                } else {
                    results.push('âŒ æ—¥è®°æ•°æ®åŠ è½½å¼‚å¸¸');
                }
                
                if (annualResult.success && annualResult.existing) {
                    results.push('âœ… å¹´åº¦æŠ¥å‘Šå†å²è®°å½•æ˜¾ç¤ºæ­£å¸¸');
                } else if (annualResult.needGenerate) {
                    results.push('âœ… å¹´åº¦æŠ¥å‘Šç”Ÿæˆé€»è¾‘æ­£å¸¸');
                } else {
                    results.push('âŒ å¹´åº¦æŠ¥å‘ŠåŠŸèƒ½å¼‚å¸¸');
                }
                
                showResult('historyTestResult', results.join('<br>'), results.every(r => r.startsWith('âœ…')) ? 'success' : 'error');
                log('âœ… å†å²è®°å½•æ˜¾ç¤ºæµ‹è¯•å®Œæˆ');
                
            } catch (error) {
                log('âŒ å†å²è®°å½•æ˜¾ç¤ºæµ‹è¯•å¤±è´¥: ' + error.message);
                showResult('historyTestResult', 'å†å²è®°å½•æ˜¾ç¤ºæµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡ŒHTMLç»“æ„æµ‹è¯•
        window.addEventListener('load', () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è‡ªåŠ¨æµ‹è¯•...');
            testHTMLStructure();
        });
    </script>
</body>
</html>