<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»ªè¡¨ç›˜æ”¹è¿›æµ‹è¯•</title>
    <link rel="icon" type="image/x-icon" href="../icon/icon-32x32.ico">
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .test-button { background: #3498db; color: white; border: none; padding: 12px 24px; margin: 8px; border-radius: 4px; cursor: pointer; }
        .test-button:hover { background: #2980b9; }
        .test-results { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status-indicator.success { background: #27ae60; }
        .status-indicator.error { background: #e74c3c; }
        .status-indicator.warning { background: #f39c12; }
        .status-indicator.info { background: #3498db; }
    </style>
</head>
<body>
    <h1>ä»ªè¡¨ç›˜æ”¹è¿›æµ‹è¯•</h1>
    <p>æµ‹è¯•ä»ªè¡¨ç›˜çš„æ”¹è¿›åŠŸèƒ½ï¼šé»˜è®¤æŠ˜å å†å²è®°å½•ã€æ˜¾ç¤ºæ•°æ®åº“æ•°æ®ç­‰</p>

    <div class="test-section">
        <h2>ğŸ”§ ç•Œé¢æ”¹è¿›æµ‹è¯•</h2>
        <p>æµ‹è¯•ç•Œé¢æ”¹è¿›æ•ˆæœï¼š</p>
        
        <button class="test-button" onclick="testDashboardUI()">ğŸ¨ æµ‹è¯•ç•Œé¢æ”¹è¿›</button>
        <button class="test-button" onclick="openDashboard()">ğŸ“Š æ‰“å¼€ä»ªè¡¨ç›˜</button>
        
        <div id="uiResults" class="test-results"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“Š æ•°æ®åº“æ•°æ®æ˜¾ç¤ºæµ‹è¯•</h2>
        <p>æµ‹è¯•ä»ªè¡¨ç›˜æ˜¯å¦èƒ½æ­£ç¡®æ˜¾ç¤ºæ•°æ®åº“ä¸­çš„æ•°æ®ï¼š</p>
        
        <button class="test-button" onclick="testDatabaseData()">ğŸ—„ï¸ æµ‹è¯•æ•°æ®åº“æ•°æ®æ˜¾ç¤º</button>
        <button class="test-button" onclick="testHistoryData()">ğŸ“š æµ‹è¯•å†å²è®°å½•æ˜¾ç¤º</button>
        <button class="test-button" onclick="testDiaryData()">ğŸ“ æµ‹è¯•æ—¥è®°æ•°æ®æ˜¾ç¤º</button>
        
        <div id="dataResults" class="test-results"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“ˆ æ•°æ®ç»Ÿè®¡æµ‹è¯•</h2>
        <p>æµ‹è¯•æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤ºï¼š</p>
        
        <button class="test-button" onclick="testDatabaseStats()">ğŸ“Š æµ‹è¯•æ•°æ®åº“ç»Ÿè®¡</button>
        <button class="test-button" onclick="createTestData()">ğŸ§ª åˆ›å»ºæµ‹è¯•æ•°æ®</button>
        
        <div id="statsResults" class="test-results"></div>
    </div>

    <script src="../lib/idb.js"></script>
    <script src="../lib/error-handler.js"></script>
    <script src="../lib/mimir-db.js"></script>
    <script src="../lib/db-wrapper.js"></script>

    <script>
        function log(section, message, type = 'info') {
            const resultsDiv = document.getElementById(section + 'Results');
            const timestamp = new Date().toLocaleTimeString();
            const statusClass = type === 'error' ? 'error' : type === 'warning' ? 'warning' : type === 'success' ? 'success' : 'info';
            resultsDiv.innerHTML += `<div><span class="status-indicator ${statusClass}"></span>[${timestamp}] ${message}</div>`;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        // ç•Œé¢æ”¹è¿›æµ‹è¯•
        function testDashboardUI() {
            log('ui', 'æµ‹è¯•ç•Œé¢æ”¹è¿›...', 'info');
            
            // æ£€æŸ¥æ”¹è¿›é¡¹ç›®
            const improvements = [
                'âœ… ä»Šæ—¥æµè§ˆå†å²é»˜è®¤æŠ˜å ï¼ˆç§»é™¤äº†openå±æ€§ï¼‰',
                'âœ… åˆ é™¤äº†é‡å¤çš„â–¼ç¬¦å·',
                'âœ… æ·»åŠ äº†æ•°æ®åº“ç»Ÿè®¡æ˜¾ç¤ºå®¹å™¨',
                'âœ… å¢å¼ºäº†æ•°æ®åŠ è½½é€»è¾‘'
            ];
            
            improvements.forEach(improvement => {
                log('ui', improvement, 'success');
            });
            
            log('ui', 'ç•Œé¢æ”¹è¿›æµ‹è¯•å®Œæˆï¼', 'success');
        }

        function openDashboard() {
            try {
                log('ui', 'æ­£åœ¨æ‰“å¼€ä»ªè¡¨ç›˜...', 'info');
                window.open('../dashboard.html', '_blank');
                log('ui', 'âœ“ ä»ªè¡¨ç›˜å·²æ‰“å¼€ï¼Œè¯·æ£€æŸ¥æ”¹è¿›æ•ˆæœ', 'success');
            } catch (error) {
                log('ui', `âœ— æ‰“å¼€ä»ªè¡¨ç›˜å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ•°æ®åº“æ•°æ®æ˜¾ç¤ºæµ‹è¯•
        async function testDatabaseData() {
            try {
                log('data', 'æµ‹è¯•æ•°æ®åº“æ•°æ®æ˜¾ç¤º...', 'info');
                
                const db = new MimirDB();
                await db.initialize();
                
                // æ£€æŸ¥å„ç±»æ•°æ®
                const [historyRecords, diaryRecords, classifiedRecords] = await Promise.all([
                    db.getAllHistory(),
                    db.getAllDiaries(),
                    db.getAllClassifiedData()
                ]);
                
                log('data', `âœ“ å†å²è®°å½•: ${historyRecords.length} æ¡`, 'success');
                log('data', `âœ“ æ—¥è®°è®°å½•: ${diaryRecords.length} æ¡`, 'success');
                log('data', `âœ“ åˆ†ç±»ç¼“å­˜: ${classifiedRecords.length} æ¡`, 'success');
                
                if (historyRecords.length > 0) {
                    log('data', 'âœ“ æ•°æ®åº“ä¸­æœ‰å†å²è®°å½•ï¼Œä»ªè¡¨ç›˜åº”è¯¥èƒ½æ˜¾ç¤º', 'success');
                } else {
                    log('data', 'âš  æ•°æ®åº“ä¸­æ²¡æœ‰å†å²è®°å½•ï¼Œå»ºè®®å…ˆè¿›è¡Œå¤‡ä»½', 'warning');
                }
                
            } catch (error) {
                log('data', `âœ— æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testHistoryData() {
            try {
                log('data', 'æµ‹è¯•å†å²è®°å½•æ•°æ®...', 'info');
                
                const db = new MimirDB();
                await db.initialize();
                
                const today = new Date().toISOString().split('T')[0];
                const allHistory = await db.getAllHistory();
                const todayHistory = allHistory.filter(record => record.date === today);
                
                log('data', `âœ“ ä»Šæ—¥å†å²è®°å½•: ${todayHistory.length} æ¡`, 'success');
                
                if (todayHistory.length > 0) {
                    const sample = todayHistory[0];
                    log('data', `âœ“ ç¤ºä¾‹è®°å½•: ${sample.title}`, 'info');
                    log('data', `âœ“ è®¿é—®æ—¶é—´: ${new Date(sample.timestamp).toLocaleString()}`, 'info');
                } else {
                    log('data', 'âš  ä»Šæ—¥æ²¡æœ‰å†å²è®°å½•ï¼Œä»ªè¡¨ç›˜ä¼šæ˜¾ç¤ºç©ºçŠ¶æ€', 'warning');
                }
                
            } catch (error) {
                log('data', `âœ— æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testDiaryData() {
            try {
                log('data', 'æµ‹è¯•æ—¥è®°æ•°æ®...', 'info');
                
                if (!window.dbWrapper) {
                    window.dbWrapper = new DatabaseWrapper();
                    await window.dbWrapper.initialize();
                }
                
                const today = new Date().toISOString().split('T')[0];
                const diaryKey = `diary-${today}`;
                const diaryResult = await window.dbWrapper.get(diaryKey);
                
                if (diaryResult[diaryKey]) {
                    log('data', 'âœ“ æ‰¾åˆ°ä»Šæ—¥æ—¥è®°æ•°æ®', 'success');
                    log('data', `âœ“ æ—¥è®°å†…å®¹é•¿åº¦: ${diaryResult[diaryKey].length} å­—ç¬¦`, 'info');
                } else {
                    log('data', 'âš  ä»Šæ—¥æ²¡æœ‰æ—¥è®°æ•°æ®', 'warning');
                }
                
                // æ£€æŸ¥åˆ†ç±»æ•°æ®
                const classifiedKey = `classified-${today}`;
                const classifiedResult = await window.dbWrapper.get(classifiedKey);
                
                if (classifiedResult[classifiedKey]) {
                    log('data', 'âœ“ æ‰¾åˆ°ä»Šæ—¥åˆ†ç±»æ•°æ®', 'success');
                } else {
                    log('data', 'âš  ä»Šæ—¥æ²¡æœ‰åˆ†ç±»æ•°æ®', 'warning');
                }
                
            } catch (error) {
                log('data', `âœ— æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ•°æ®ç»Ÿè®¡æµ‹è¯•
        async function testDatabaseStats() {
            try {
                log('stats', 'æµ‹è¯•æ•°æ®åº“ç»Ÿè®¡åŠŸèƒ½...', 'info');
                
                const db = new MimirDB();
                await db.initialize();
                
                const [historyRecords, diaryRecords, classifiedRecords, reportRecords] = await Promise.all([
                    db.getAllHistory(),
                    db.getAllDiaries(),
                    db.getAllClassifiedData(),
                    db.getAllAnnualReports()
                ]);
                
                const stats = {
                    historyCount: historyRecords.length,
                    diaryCount: diaryRecords.length,
                    classifiedCount: classifiedRecords.length,
                    reportCount: reportRecords.length
                };
                
                log('stats', 'âœ“ æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯:', 'success');
                log('stats', `  ğŸ“š å†å²è®°å½•: ${stats.historyCount.toLocaleString()} æ¡`, 'info');
                log('stats', `  ğŸ“ æ—¥è®°: ${stats.diaryCount} æ¡`, 'info');
                log('stats', `  ğŸ·ï¸ åˆ†ç±»ç¼“å­˜: ${stats.classifiedCount} æ¡`, 'info');
                log('stats', `  ğŸ“Š å¹´åº¦æŠ¥å‘Š: ${stats.reportCount} æ¡`, 'info');
                
                if (stats.historyCount > 0) {
                    log('stats', 'âœ“ ä»ªè¡¨ç›˜åº”è¯¥èƒ½æ˜¾ç¤ºè¿™äº›ç»Ÿè®¡ä¿¡æ¯', 'success');
                } else {
                    log('stats', 'âš  æ•°æ®åº“ä¸ºç©ºï¼Œå»ºè®®å…ˆè¿›è¡Œæ•°æ®å¤‡ä»½', 'warning');
                }
                
            } catch (error) {
                log('stats', `âœ— æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function createTestData() {
            try {
                log('stats', 'åˆ›å»ºæµ‹è¯•æ•°æ®...', 'info');
                
                const db = new MimirDB();
                await db.initialize();
                
                // åˆ›å»ºæµ‹è¯•å†å²è®°å½•
                const testHistory = {
                    timestamp: Date.now(),
                    date: new Date().toISOString().split('T')[0],
                    url: 'https://test.example.com',
                    title: 'æµ‹è¯•é¡µé¢ - ä»ªè¡¨ç›˜æ”¹è¿›éªŒè¯',
                    domain: 'test.example.com',
                    visitCount: 1,
                    lastVisitTime: Date.now()
                };
                
                await db.addHistoryRecord(testHistory);
                log('stats', 'âœ“ åˆ›å»ºäº†æµ‹è¯•å†å²è®°å½•', 'success');
                
                // åˆ›å»ºæµ‹è¯•æ—¥è®°
                if (!window.dbWrapper) {
                    window.dbWrapper = new DatabaseWrapper();
                    await window.dbWrapper.initialize();
                }
                
                const today = new Date().toISOString().split('T')[0];
                const testDiary = 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ—¥è®°ï¼Œç”¨äºéªŒè¯ä»ªè¡¨ç›˜æ”¹è¿›åŠŸèƒ½ã€‚';
                await window.dbWrapper.set({ [`diary-${today}`]: testDiary });
                log('stats', 'âœ“ åˆ›å»ºäº†æµ‹è¯•æ—¥è®°', 'success');
                
                // åˆ›å»ºæµ‹è¯•åˆ†ç±»æ•°æ®
                const testClassified = {
                    categories: { 'æµ‹è¯•': 1 },
                    summary: 'æµ‹è¯•åˆ†ç±»æ•°æ®',
                    timestamp: Date.now()
                };
                await window.dbWrapper.set({ [`classified-${today}`]: testClassified });
                log('stats', 'âœ“ åˆ›å»ºäº†æµ‹è¯•åˆ†ç±»æ•°æ®', 'success');
                
                log('stats', 'âœ“ æµ‹è¯•æ•°æ®åˆ›å»ºå®Œæˆï¼ç°åœ¨å¯ä»¥æµ‹è¯•ä»ªè¡¨ç›˜æ˜¾ç¤ºæ•ˆæœ', 'success');
                
            } catch (error) {
                log('stats', `âœ— åˆ›å»ºæµ‹è¯•æ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.addEventListener('load', () => {
            log('ui', 'ä»ªè¡¨ç›˜æ”¹è¿›æµ‹è¯•é¡µé¢å·²åŠ è½½', 'success');
            log('data', 'æ•°æ®æ˜¾ç¤ºæµ‹è¯•å‡†å¤‡å°±ç»ª', 'success');
            log('stats', 'ç»Ÿè®¡åŠŸèƒ½æµ‹è¯•å‡†å¤‡å°±ç»ª', 'success');
        });
    </script>
</body>
</html>