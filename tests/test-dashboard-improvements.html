<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>仪表盘改进测试</title>
    <link rel="icon" type="image/x-icon" href="../icon/icon-32x32.ico">
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .test-button { background: #3498db; color: white; border: none; padding: 12px 24px; margin: 8px; border-radius: 4px; cursor: pointer; }
        .test-button:hover { background: #2980b9; }
        .test-results { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status-indicator.success { background: #27ae60; }
        .status-indicator.error { background: #e74c3c; }
        .status-indicator.warning { background: #f39c12; }
        .status-indicator.info { background: #3498db; }
    </style>
</head>
<body>
    <h1>仪表盘改进测试</h1>
    <p>测试仪表盘的改进功能：默认折叠历史记录、显示数据库数据等</p>

    <div class="test-section">
        <h2>🔧 界面改进测试</h2>
        <p>测试界面改进效果：</p>
        
        <button class="test-button" onclick="testDashboardUI()">🎨 测试界面改进</button>
        <button class="test-button" onclick="openDashboard()">📊 打开仪表盘</button>
        
        <div id="uiResults" class="test-results"></div>
    </div>

    <div class="test-section">
        <h2>📊 数据库数据显示测试</h2>
        <p>测试仪表盘是否能正确显示数据库中的数据：</p>
        
        <button class="test-button" onclick="testDatabaseData()">🗄️ 测试数据库数据显示</button>
        <button class="test-button" onclick="testHistoryData()">📚 测试历史记录显示</button>
        <button class="test-button" onclick="testDiaryData()">📝 测试日记数据显示</button>
        
        <div id="dataResults" class="test-results"></div>
    </div>

    <div class="test-section">
        <h2>📈 数据统计测试</h2>
        <p>测试数据库统计信息显示：</p>
        
        <button class="test-button" onclick="testDatabaseStats()">📊 测试数据库统计</button>
        <button class="test-button" onclick="createTestData()">🧪 创建测试数据</button>
        
        <div id="statsResults" class="test-results"></div>
    </div>

    <script src="../lib/idb.js"></script>
    <script src="../lib/error-handler.js"></script>
    <script src="../lib/mimir-db.js"></script>
    <script src="../lib/db-wrapper.js"></script>

    <script>
        function log(section, message, type = 'info') {
            const resultsDiv = document.getElementById(section + 'Results');
            const timestamp = new Date().toLocaleTimeString();
            const statusClass = type === 'error' ? 'error' : type === 'warning' ? 'warning' : type === 'success' ? 'success' : 'info';
            resultsDiv.innerHTML += `<div><span class="status-indicator ${statusClass}"></span>[${timestamp}] ${message}</div>`;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        // 界面改进测试
        function testDashboardUI() {
            log('ui', '测试界面改进...', 'info');
            
            // 检查改进项目
            const improvements = [
                '✅ 今日浏览历史默认折叠（移除了open属性）',
                '✅ 删除了重复的▼符号',
                '✅ 添加了数据库统计显示容器',
                '✅ 增强了数据加载逻辑'
            ];
            
            improvements.forEach(improvement => {
                log('ui', improvement, 'success');
            });
            
            log('ui', '界面改进测试完成！', 'success');
        }

        function openDashboard() {
            try {
                log('ui', '正在打开仪表盘...', 'info');
                window.open('../dashboard.html', '_blank');
                log('ui', '✓ 仪表盘已打开，请检查改进效果', 'success');
            } catch (error) {
                log('ui', `✗ 打开仪表盘失败: ${error.message}`, 'error');
            }
        }

        // 数据库数据显示测试
        async function testDatabaseData() {
            try {
                log('data', '测试数据库数据显示...', 'info');
                
                const db = new MimirDB();
                await db.initialize();
                
                // 检查各类数据
                const [historyRecords, diaryRecords, classifiedRecords] = await Promise.all([
                    db.getAllHistory(),
                    db.getAllDiaries(),
                    db.getAllClassifiedData()
                ]);
                
                log('data', `✓ 历史记录: ${historyRecords.length} 条`, 'success');
                log('data', `✓ 日记记录: ${diaryRecords.length} 条`, 'success');
                log('data', `✓ 分类缓存: ${classifiedRecords.length} 条`, 'success');
                
                if (historyRecords.length > 0) {
                    log('data', '✓ 数据库中有历史记录，仪表盘应该能显示', 'success');
                } else {
                    log('data', '⚠ 数据库中没有历史记录，建议先进行备份', 'warning');
                }
                
            } catch (error) {
                log('data', `✗ 测试失败: ${error.message}`, 'error');
            }
        }

        async function testHistoryData() {
            try {
                log('data', '测试历史记录数据...', 'info');
                
                const db = new MimirDB();
                await db.initialize();
                
                const today = new Date().toISOString().split('T')[0];
                const allHistory = await db.getAllHistory();
                const todayHistory = allHistory.filter(record => record.date === today);
                
                log('data', `✓ 今日历史记录: ${todayHistory.length} 条`, 'success');
                
                if (todayHistory.length > 0) {
                    const sample = todayHistory[0];
                    log('data', `✓ 示例记录: ${sample.title}`, 'info');
                    log('data', `✓ 访问时间: ${new Date(sample.timestamp).toLocaleString()}`, 'info');
                } else {
                    log('data', '⚠ 今日没有历史记录，仪表盘会显示空状态', 'warning');
                }
                
            } catch (error) {
                log('data', `✗ 测试失败: ${error.message}`, 'error');
            }
        }

        async function testDiaryData() {
            try {
                log('data', '测试日记数据...', 'info');
                
                if (!window.dbWrapper) {
                    window.dbWrapper = new DatabaseWrapper();
                    await window.dbWrapper.initialize();
                }
                
                const today = new Date().toISOString().split('T')[0];
                const diaryKey = `diary-${today}`;
                const diaryResult = await window.dbWrapper.get(diaryKey);
                
                if (diaryResult[diaryKey]) {
                    log('data', '✓ 找到今日日记数据', 'success');
                    log('data', `✓ 日记内容长度: ${diaryResult[diaryKey].length} 字符`, 'info');
                } else {
                    log('data', '⚠ 今日没有日记数据', 'warning');
                }
                
                // 检查分类数据
                const classifiedKey = `classified-${today}`;
                const classifiedResult = await window.dbWrapper.get(classifiedKey);
                
                if (classifiedResult[classifiedKey]) {
                    log('data', '✓ 找到今日分类数据', 'success');
                } else {
                    log('data', '⚠ 今日没有分类数据', 'warning');
                }
                
            } catch (error) {
                log('data', `✗ 测试失败: ${error.message}`, 'error');
            }
        }

        // 数据统计测试
        async function testDatabaseStats() {
            try {
                log('stats', '测试数据库统计功能...', 'info');
                
                const db = new MimirDB();
                await db.initialize();
                
                const [historyRecords, diaryRecords, classifiedRecords, reportRecords] = await Promise.all([
                    db.getAllHistory(),
                    db.getAllDiaries(),
                    db.getAllClassifiedData(),
                    db.getAllAnnualReports()
                ]);
                
                const stats = {
                    historyCount: historyRecords.length,
                    diaryCount: diaryRecords.length,
                    classifiedCount: classifiedRecords.length,
                    reportCount: reportRecords.length
                };
                
                log('stats', '✓ 数据库统计信息:', 'success');
                log('stats', `  📚 历史记录: ${stats.historyCount.toLocaleString()} 条`, 'info');
                log('stats', `  📝 日记: ${stats.diaryCount} 条`, 'info');
                log('stats', `  🏷️ 分类缓存: ${stats.classifiedCount} 条`, 'info');
                log('stats', `  📊 年度报告: ${stats.reportCount} 条`, 'info');
                
                if (stats.historyCount > 0) {
                    log('stats', '✓ 仪表盘应该能显示这些统计信息', 'success');
                } else {
                    log('stats', '⚠ 数据库为空，建议先进行数据备份', 'warning');
                }
                
            } catch (error) {
                log('stats', `✗ 测试失败: ${error.message}`, 'error');
            }
        }

        async function createTestData() {
            try {
                log('stats', '创建测试数据...', 'info');
                
                const db = new MimirDB();
                await db.initialize();
                
                // 创建测试历史记录
                const testHistory = {
                    timestamp: Date.now(),
                    date: new Date().toISOString().split('T')[0],
                    url: 'https://test.example.com',
                    title: '测试页面 - 仪表盘改进验证',
                    domain: 'test.example.com',
                    visitCount: 1,
                    lastVisitTime: Date.now()
                };
                
                await db.addHistoryRecord(testHistory);
                log('stats', '✓ 创建了测试历史记录', 'success');
                
                // 创建测试日记
                if (!window.dbWrapper) {
                    window.dbWrapper = new DatabaseWrapper();
                    await window.dbWrapper.initialize();
                }
                
                const today = new Date().toISOString().split('T')[0];
                const testDiary = '这是一条测试日记，用于验证仪表盘改进功能。';
                await window.dbWrapper.set({ [`diary-${today}`]: testDiary });
                log('stats', '✓ 创建了测试日记', 'success');
                
                // 创建测试分类数据
                const testClassified = {
                    categories: { '测试': 1 },
                    summary: '测试分类数据',
                    timestamp: Date.now()
                };
                await window.dbWrapper.set({ [`classified-${today}`]: testClassified });
                log('stats', '✓ 创建了测试分类数据', 'success');
                
                log('stats', '✓ 测试数据创建完成！现在可以测试仪表盘显示效果', 'success');
                
            } catch (error) {
                log('stats', `✗ 创建测试数据失败: ${error.message}`, 'error');
            }
        }

        // 页面加载时的初始化
        window.addEventListener('load', () => {
            log('ui', '仪表盘改进测试页面已加载', 'success');
            log('data', '数据显示测试准备就绪', 'success');
            log('stats', '统计功能测试准备就绪', 'success');
        });
    </script>
</body>
</html>